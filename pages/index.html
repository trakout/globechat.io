<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="intro no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="intro no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="intro no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="intro no-js"> <!--<![endif]-->
<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>GlobeChat</title>

	<meta name="keywords" content="GlobeChat: Talk the Talk">
	<meta name="description" content="Speak with friends and strangers alike from all borders of the world. Language is not a border.">

	<meta name="viewport" content="width=device-width">

	<link rel="shortcut icon" href="favicon.ico">
	<link rel="apple-touch-icon" href="apple-touch-icon-precomposed.png">

	<link rel="stylesheet" href="main.css">
	<script src="modernizr-2.6.2.min.js"></script>
</head>
<body>
<!--[if lt IE 8]>
	<p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
	<![endif]-->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<!--[if gte IE 9]>
	<style type="text/css">
		.gradient {
			filter: none;
		}
	</style>
<![endif]-->

	

	<div class="logo">
		<i class="fa fa-globe fa-5x"></i>
	</div>

	<h1>GlobeChat!!</h1>

	<form id="changeNameForm" action="">
		<input id="usernameInput" autocomplete="off" /><button>Change Name</button>
	</form>

	<video id="localVideo" width="320" height="240" autoplay></video>  
	<div id="conversationSection">
		<h3>Transcript here:</h3>
		<ul id="conversationTranscript"></ul>
		<form id="conversationForm" action="">
			<input id="messageInput" autocomplete="off" /><button>Send</button>
		</form>
	</div>

	<h3>Online users (click to send request):</h3>
	<ul id="onlineUsers"></ul>

	<h3>Chat requests (click to start chat):</h3>
	<ul id="chatRequests"></ul>

	<script src="plugins.js"></script>
	<script src="main.js"></script>
	<script src='http://static.opentok.com/webrtc/v2.2/js/opentok.min.js'></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script>

		$(document).ready(function() {
			$('#conversationSection').hide();

			var _userObject;

			/*************************************************************************************

			* BUTTON HANDLER RELATED STUFF

			*************************************************************************************/

			$('#onlineUsers').on('click','li.onlineUser',function() {    
				requestToChatWithUser($(this).data("user-id"));
			});

			$('#chatRequests').on('click','li.chatRequest',function() {    
				console.log($(this).data("user-id"));
				acceptChatRequest($(this).data("user-id"));
			});

			/*************************************************************************************

			* VIDEO RELATED STUFF

			*************************************************************************************/

			function startOpenTok(roomObject) {
				console.log(roomObject);
				var apiKey = "45102212";
				var session = OT.initSession(apiKey, roomObject.id);

				session.on("streamCreated", function(event) {
					console.log('OpenTok stream created');
					session.subscribe(event.stream);
				});

				session.connect(roomObject.token, function(error) {
					console.log('OpenTok session connected');
					var publisher = OT.initPublisher();
					session.publish(publisher);
				});
			}

			/*************************************************************************************

			* SOCKET RELATED STUFF

			*************************************************************************************/
			var socket = io();
			$('#conversationForm').submit(function(){

				// send to the server the message
				socket.emit('chatMessage', $('#messageInput').val());
					$('#messageInput').val('');
				return false;
			});

			$('#changeNameForm').submit(function(){

				// send to the server the message
				socket.emit('changeName', $('#usernameInput').val());
				return false;
			});

			// recieved message
			socket.on('chatMessage', function(msg){
				$('#conversationTranscript').append($('<li>').text(msg));
			});

			socket.on('startChat', function (roomObject) {
				console.log('starting chat');
				$('#conversationSection').show();

				startOpenTok(roomObject);
			});

			socket.on('receiveChatRequest', function (userObject) {
				console.log("recieved: "+ userObject);
				if ($('#chatRequests').find('[data-user-id="' + userObject.id + '"]').length == 0) {
					$('#chatRequests').append('<li class="chatRequest" data-user-id="'+userObject.id+'">'+userObject.name+'</li>');
				}
			});

			socket.on('updatedUserObject', function (userObject) {
				_userObject = userObject;
				$('#usernameInput').val(userObject.name);
			});

			// recieved a list of people online
			// NOTE: this will probably be a list of objects later, right now it is strings
			socket.on('listOfUsersOnline', function(userArray) {

				// refresh the list of online users
				$('#onlineUsers').empty();
				var keys = Object.keys(userArray);
				for (var i=0; i<keys.length; ++i) {
					var userObject = userArray[keys[i]];
					if (userObject.id != _userObject.id) {
						$('#onlineUsers').append('<li class="onlineUser" data-user-id="'+userObject.id+'">'+userObject.name+'</li>');
					}
				}
			});

			socket.on('receivedSessionDescription', function(sessionDescription) {
				console.log('received session description: ' + sessionDescription);
			});

			socket.on('receivedCandidateEvent', function(candidateEvent) {
				console.log('got candidate event');
				var candidate = new RTCIceCandidate({
					sdpMLineIndex: candidateEvent.label,
					candidate: candidateEvent.candidate
				});
			});

			function requestToChatWithUser(userId) {
				socket.emit('sendChatRequest', userId);
			}

			function acceptChatRequest(userId) {
				socket.emit('acceptChatRequest', userId);
			}

			// function sendCandidateEvent(event) {
			// 	socket.emit('sendCandidateEvent', {
			// 		type: 'candidate',
			// 		label: event.candidate.sdpMLineIndex,
			// 		id: event.candidate.sdpMid,
			// 		candidate: event.candidate.candidate
			// 	});
			// }

			// function sendSessionDescription(sessionDescription) {
			// 	console.log('sending session description');
			// 	socket.emit('sendSessionDescription', sessionDescription);
			// }
		}); 

	</script>
</body>
</html>

