function runSocket(){function e(){a=new webkitSpeechRecognition,a.continuous=!0,a.interimResults=!0,a.lang="en-CA",a.onresult=function(e){for(var t=e.resultIndex;t<e.results.length;++t)e.results[t].isFinal&&o(e.results[t][0].transcript.trim())},a.onstart=function(){console.log("webkitSpeechRecognition started")},a.onerror=function(e){console.log("webkitSpeechRecognition error "+e.error)},a.start()}function t(e){apiKey="45102212",session=OT.initSession(apiKey,e.id),session.on("streamCreated",function(e){console.log("OpenTok stream created"),session.subscribe(e.stream,"videoPublish")}),session.connect(e.token,function(){console.log("OpenTok session connected"),loadChatRoom()})}function n(e){socket.emit("sendChatRequest",e)}function i(e){socket.emit("acceptChatRequest",e)}function o(e){socket.emit("transcribedText",e)}$("#conversationSection").hide();var s,a;$("#onlineUsers").on("click","li.onlineUser",function(){n($(this).data("user-id"))}),$("#chatRequests").on("click","li.chatRequest",function(){console.log($(this).data("user-id")),i($(this).data("user-id"))}),socket=io(),$("#changeNameForm").submit(function(){return socket.emit("changeName",$("#usernameInput").val()),!1}),socket.on("chatMessage",function(e){$("#conversationTranscript").append($('<li class="normal">').text(e))}),socket.on("transcribedText",function(e){$("#conversationTranscript").append($('<li class="transcribed">').text(e))}),socket.on("startChat",function(n){console.log("starting chat"),$("#conversationSection").show(),t(n),e()}),socket.on("receiveChatRequest",function(e){console.log("recieved: "+e),0==$("#chatRequests").find('[data-user-id="'+e.id+'"]').length&&$("#chatRequests").append('<li class="chatRequest" data-user-id="'+e.id+'">'+e.name+"</li>")}),socket.on("updatedUserObject",function(e){s=e,$("#usernameInput").val(e.name)}),socket.on("listOfUsersOnline",function(e){$("#onlineUsers").empty();for(var t=Object.keys(e),n=0;n<t.length;++n){var i=e[t[n]];i.id!=s.id&&$("#onlineUsers").append('<li class="onlineUser" data-user-id="'+i.id+'">'+i.name+"</li>")}}),socket.on("receivedSessionDescription",function(e){console.log("received session description: "+e)}),socket.on("receivedCandidateEvent",function(e){console.log("got candidate event");new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate})})}function loadChatRoom(){console.log("loading"),$("body").fadeOut("fast",function(){$("body").load("/chat.html .chat-parent",function(){publisher=OT.initPublisher(apiKey,"videoSelfie"),session.publish(publisher),$("body").fadeIn("fast"),checkDom()})})}function sendString(e){$("#conversationSection h3").length>0&&(console.log("removal"),$("#conversationSection h3").fadeOut("fast",function(){$("#conversationSection h3").remove()})),socket.emit("chatMessage",e)}function enterShort(){$(".text-button").click(function(){sendString($(".text-submit textarea").val()),TweenMax.to(".text-submit textarea",.2,{opacity:0,onComplete:function(){$("textarea").val(""),TweenMax.to(".text-submit textarea",.1,{opacity:1})}})}),$(".text-submit textarea").bind("keydown",function(e){var t=e.keyCode||e.which;if(13==t&&0==e.shiftKey&&$(".text-submit textarea").val().length>0){var n=$(".text-submit textarea").val(),i=n.match(/\n/g),o=i?i.length:0;1!=$(".text-submit textarea").val().length||1!=o?(sendString($(".text-submit textarea").val()),TweenMax.to(".text-submit textarea",.2,{opacity:0,onComplete:function(){$("textarea").val(""),TweenMax.to(".text-submit textarea",.1,{opacity:1})}})):$("textarea").val("")}})}function autoResize(e){var t=e.target,n=t.scrollTop;t.scrollTop=0;var i,o=$(".text-area").height()-30;0!=e.shiftKey||13!=e.keyCode&&13!=e.which?(i=t.offsetHeight+n+n>o?o:t.offsetHeight+n+n,0==$("textarea").val().length&&(t.style.height="14px",$(".text-submit").css("height","30px")),n>0&&(t.style.height=i-16+"px",$(".text-submit").css("height",i+"px"))):(t.style.height="14px",$(".text-submit").css("height","30px"))}function runResizes(){$(".recipient").resizable({resize:function(){$(".text-area").css("height",$("body").height()-$(".recipient").height()+"px")},maxHeight:.85*$("body").height(),minHeight:.15*$("body").height(),handles:"s"}),$(".viewer").resizable({aspectRatio:!0,maxWidth:$(".recipient").width()/2,minWidth:50,handles:"e"})}function checkDom(){$(".chat").length>0&&(runResizes(),enterShort())}var publisher,session,apiKey,socket;$(document).ready(function(){checkDom(),runSocket()});