function runSocket(){function e(){r=new webkitSpeechRecognition,r.continuous=!0,r.interimResults=!0,r.lang=c.language,r.onresult=function(e){for(var t=e.resultIndex;t<e.results.length;++t)e.results[t].isFinal&&(console.log("sending text to transcibe: "+e.results[t][0].transcript.trim()),o(e.results[t][0].transcript.trim()))},r.onstart=function(){console.log("webkitSpeechRecognition started")},r.onerror=function(e){console.log("webkitSpeechRecognition error "+e.error),r.start()},r.start()}function t(e,t){shared=t,apiKey="45102212",session=OT.initSession(apiKey,e.id),session.on("streamCreated",function(e){console.log("OpenTok stream created"),session.subscribe(e.stream,"videoPublish")}),session.connect(e.token,function(){console.log("OpenTok session connected"),loadChatRoom(shared)})}function n(e){socket.emit("sendChatRequest",e)}function i(e){socket.emit("acceptChatRequest",e)}function o(e){socket.emit("transcribedText",e)}function s(e){socket.emit("changeUserLanguage",e)}function a(){socket.emit("endConversation")}$("#conversationSection").hide();var c,r;$("#onlineUsers").on("click","li.onlineUser",function(){n($(this).data("user-id"))}),$("#chatRequests").on("click","li.chatRequest",function(){console.log($(this).data("user-id")),i($(this).data("user-id"))}),$("#userLanguage").on("change",function(){var e=$(this).find("option:selected"),t=e.val();s(t)}),$("body").on("click","#closeChat",function(){console.log("closing"),a()}),socket=io(),$("#changeNameForm").submit(function(){return socket.emit("changeName",$("#usernameInput").val()),!1}),socket.on("chatMessage",function(e){$("#conversationTranscript").append($('<li class="normal">').text(e))}),socket.on("transcribedText",function(e){$("#conversationSection h3").length>0&&$("#conversationSection h3").fadeOut("fast",function(){$("#conversationSection h3").remove()}),$("#conversationTranscript").append($('<li class="transcribed">').append($(e)))}),socket.on("startChat",function(n,i){console.log("starting chat"),$("#conversationSection").show(),t(n,i),e()}),socket.on("receiveChatRequest",function(e){console.log("recieved: "+e),0==$("#chatRequests").find('[data-user-id="'+e.id+'"]').length&&($("html, body").animate({scrollTop:$("h3.requestTop").offset().top},300),$("#chatRequests").append('<li class="chatRequest" data-user-id="'+e.id+'">'+e.name+"</li>"))}),socket.on("updatedUserObject",function(e){c=e,$("#usernameInput").val(e.name)}),socket.on("listOfUsersOnline",function(e){$("#onlineUsers").empty();for(var t=Object.keys(e),n=0;n<t.length;++n){var i=e[t[n]];console.log(i),i.hasOwnProperty("image")?i.id!=c.id&&$("#onlineUsers").append('<li class="onlineUser" data-user-id="'+i.id+'">'+i.name+'<img src="data:image/png;base64,'+i.image+'" /></li>'):i.id!=c.id&&$("#onlineUsers").append('<li class="onlineUser" data-user-id="'+i.id+'">'+i.name+"</li>")}}),socket.on("receivedSessionDescription",function(e){console.log("received session description: "+e)}),socket.on("receivedCandidateEvent",function(e){console.log("got candidate event");new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate})}),socket.on("conversationEnded",function(){loadHome()}),socket.on("refreshChatRequests",function(){console.log("emptying chat requests"),$("#chatRequests").empty()})}function loadHome(){$("body").fadeOut("fast",function(){$("body").load("/ .container",function(){$("body").fadeIn("fast"),console.log("chat ended .. jason reconnect us!"),checkDom(),indexClickHandles()})})}function loadChatRoom(e){var t=e;$("body").fadeOut("fast",function(){$("body").load("/chat.html .chat-parent",function(){publisher=OT.initPublisher(apiKey,"videoSelfie"),session.publish(publisher,function(){if(0==imageCount){imageCount++;var e=publisher.getImgData();socket.emit("userImage",e)}}),$("body").fadeIn("fast"),loadDrawer(t),checkDom()})})}function sendString(e){$("#conversationSection h3").length>0&&$("#conversationSection h3").fadeOut("fast",function(){$("#conversationSection h3").remove()}),socket.emit("chatMessage",e)}function loadDrawer(e){var t=JSON.parse(e);console.log(t),$(".drawer .location .city").html(t.city),$(".drawer .location .country").html(t.country),$(".drawer .location .time").html(t.city),$(".drawer .weather .icon").html('<img src="'+t.icon+'" />'),$(".drawer .weather .temp").html(Math.round(t.temperature)+' <span class="helv">&#176;</span>C <br>'+t.weather);var n=new Date(t.local_time),i=n.getMinutes(),o=n.getHours();$(".drawer .time").html("Local Time: <br>"+o+":"+i)}function indexClickHandles(){$("#onlineUsers").on("click","li.onlineUser",function(){requestToChatWithUser($(this).data("user-id"))}),$("#chatRequests").on("click","li.chatRequest",function(){console.log($(this).data("user-id")),acceptChatRequest($(this).data("user-id"))}),$("#userLanguage").on("change",function(){var e=$(this).find("option:selected"),t=e.val();changeUserLanguage(t)}),$("body").on("click","#closeChat",function(){console.log("closing"),closeConversation()}),$("#changeNameForm").submit(function(){return socket.emit("changeName",$("#usernameInput").val()),!1})}function enterShort(){$(".pHandle").click(function(){$(".drawer").hasClass("active")?($(".pHandle").removeClass("active"),$(".drawer").removeClass("active")):($(".pHandle").addClass("active"),$(".drawer").addClass("active"))}),$(".text-button").click(function(){sendString($(".text-submit textarea").val()),TweenMax.to(".text-submit textarea",.2,{opacity:0,onComplete:function(){$("textarea").val(""),TweenMax.to(".text-submit textarea",.1,{opacity:1})}})}),$(".text-submit textarea").bind("keydown",function(e){var t=e.keyCode||e.which;if(13==t&&0==e.shiftKey&&$(".text-submit textarea").val().length>0){var n=$(".text-submit textarea").val(),i=n.match(/\n/g),o=i?i.length:0;1!=$(".text-submit textarea").val().length||1!=o?(sendString($(".text-submit textarea").val()),TweenMax.to(".text-submit textarea",.2,{opacity:0,onComplete:function(){$("textarea").val(""),TweenMax.to(".text-submit textarea",.1,{opacity:1})}})):$("textarea").val("")}})}function autoResize(e){var t=e.target,n=t.scrollTop;t.scrollTop=0;var i,o=$(".text-area").height()-30;0!=e.shiftKey||13!=e.keyCode&&13!=e.which?(i=t.offsetHeight+n+n>o?o:t.offsetHeight+n+n,0==$("textarea").val().length&&(t.style.height="14px",$(".text-submit").css("height","30px"),$(".conversationSection").css("height",$(".text-history").height()-$(".text-submit").height()+"px")),n>0&&(t.style.height=i-16+"px",$(".text-submit").css("height",i+"px"),$(".conversationSection").css("height",$(".text-history").height()-$(".text-submit").height()+"px"))):(t.style.height="14px",$(".text-submit").css("height","30px"),$(".conversationSection").css("height",$(".text-history").height()-$(".text-submit").height()+"px"))}function runResizes(){$(".recipient").resizable({resize:function(){$(".text-area").css("height",$("body").height()-$(".recipient").height()+"px")},maxHeight:.85*$("body").height(),minHeight:.15*$("body").height(),handles:"s"}),$(".viewer").resizable({aspectRatio:!0,maxWidth:$(".recipient").width()/2,minWidth:50,handles:"e"})}function checkDom(){$(".chat").length>0&&(runResizes(),enterShort()),$("input:text").each(function(){var e=this.value;$(this).blur(function(){0==this.value.length&&(this.value=e)}).focus(function(){this.value=""})})}var publisher,session,apiKey,socket,imageCount=0,shared;$(document).ready(function(){checkDom(),runSocket()});