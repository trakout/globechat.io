function runSocket(){function e(){a=new webkitSpeechRecognition,a.continuous=!0,a.interimResults=!0,a.lang="en-CA",a.onresult=function(e){for(var t=e.resultIndex;t<e.results.length;++t)e.results[t].isFinal&&s(e.results[t][0].transcript.trim())},a.onstart=function(){console.log("webkitSpeechRecognition started")},a.onerror=function(e){console.log("webkitSpeechRecognition error "+e.error)},a.start()}function t(e){apiKey="45102212",session=OT.initSession(apiKey,e.id),loadChatRoom(e)}function n(e){c.emit("sendChatRequest",e)}function i(e){c.emit("acceptChatRequest",e)}function s(e){c.emit("transcribedText",e)}$("#conversationSection").hide();var o,a,c;$("#onlineUsers").on("click","li.onlineUser",function(){n($(this).data("user-id"))}),$("#chatRequests").on("click","li.chatRequest",function(){console.log($(this).data("user-id")),i($(this).data("user-id"))}),c=io(),$("#conversationForm").submit(function(){return c.emit("chatMessage",$("#messageInput").val()),$("#messageInput").val(""),!1}),$("#changeNameForm").submit(function(){return c.emit("changeName",$("#usernameInput").val()),!1}),c.on("chatMessage",function(e){$("#conversationTranscript").append($("<li>").text(e))}),c.on("transcribedText",function(e){$("#transcribedText").append($("<li>").text(e))}),c.on("startChat",function(n){console.log("starting chat"),$("#conversationSection").show(),t(n),e()}),c.on("receiveChatRequest",function(e){console.log("recieved: "+e),0==$("#chatRequests").find('[data-user-id="'+e.id+'"]').length&&$("#chatRequests").append('<li class="chatRequest" data-user-id="'+e.id+'">'+e.name+"</li>")}),c.on("updatedUserObject",function(e){o=e,$("#usernameInput").val(e.name)}),c.on("listOfUsersOnline",function(e){$("#onlineUsers").empty();for(var t=Object.keys(e),n=0;n<t.length;++n){var i=e[t[n]];i.id!=o.id&&$("#onlineUsers").append('<li class="onlineUser" data-user-id="'+i.id+'">'+i.name+"</li>")}}),c.on("receivedSessionDescription",function(e){console.log("received session description: "+e)}),c.on("receivedCandidateEvent",function(e){console.log("got candidate event");new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate})})}function loadChatRoom(e){$("body").fadeOut("fast",function(){$("body").load("/chat.html .chat-parent",function(){console.log(e),publisher=OT.initPublisher(apiKey,"videoSelfie"),session.publish(publisher),session.on("streamCreated",function(e){console.log("OpenTok stream created"),session.subscribe(e.stream)}),session.connect(e.token,function(){console.log("OpenTok session connected")}),$("body").fadeIn("fast")})})}function sendString(e){console.log("this was sent: "+e)}function autoResize(e){var t=e.target,n=t.scrollTop;t.scrollTop=0;var i,s=$(".text-area").height()-30;0!=e.shiftKey||13!=e.keyCode&&13!=e.which?(i=t.offsetHeight+n+n>s?s:t.offsetHeight+n+n,0==$("textarea").val().length&&(t.style.height="14px",$(".text-submit").css("height","30px")),n>0&&(t.style.height=i-16+"px",$(".text-submit").css("height",i+"px"))):(t.style.height="14px",$(".text-submit").css("height","30px"))}function runResizes(){$(".recipient").resizable({resize:function(){$(".text-area").css("height",$("body").height()-$(".recipient").height()+"px")},maxHeight:.85*$("body").height(),minHeight:.15*$("body").height(),handles:"s"}),$(".viewer").resizable({aspectRatio:!0,maxWidth:$(".recipient").width()/2,minWidth:50,handles:"e"})}function checkDom(){$(".chat").length>0&&runResizes()}var publisher,session,apiKey;$(".text-submit textarea").bind("keydown",function(e){var t=e.keyCode||e.which;if(13==t&&0==e.shiftKey&&$(".text-submit textarea").val().length>0){var n=$(".text-submit textarea").val(),i=n.match(/\n/g),s=i?i.length:0;1!=$(".text-submit textarea").val().length||1!=s?(sendString($(".text-submit textarea").val()),TweenMax.to(".text-submit textarea",.2,{opacity:0,onComplete:function(){$("textarea").val(""),TweenMax.to(".text-submit textarea",.1,{opacity:1})}})):$("textarea").val("")}}),$(document).ready(function(){checkDom(),runSocket()});