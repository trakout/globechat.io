function runSocket(){function e(){c=new webkitSpeechRecognition,c.continuous=!0,c.interimResults=!0,c.lang=s.language,c.onresult=function(e){for(var t=e.resultIndex;t<e.results.length;++t)e.results[t].isFinal&&(console.log("sending text to transcibe: "+e.results[t][0].transcript.trim()),o(e.results[t][0].transcript.trim()))},c.onstart=function(){console.log("webkitSpeechRecognition started")},c.onerror=function(e){console.log("webkitSpeechRecognition error "+e.error),c.start()},c.start()}function t(e){shared="otherUserLocationData",apiKey="45102212",session=OT.initSession(apiKey,e.id),session.on("streamCreated",function(e){console.log("OpenTok stream created"),session.subscribe(e.stream,"videoPublish")}),session.connect(e.token,function(){console.log("OpenTok session connected"),loadChatRoom(shared)})}function n(e){socket.emit("sendChatRequest",e)}function i(e){socket.emit("acceptChatRequest",e)}function o(e){socket.emit("transcribedText",e)}function a(e){socket.emit("changeUserLanguage",e)}$("#conversationSection").hide();var s,c;$("#onlineUsers").on("click","li.onlineUser",function(){n($(this).data("user-id"))}),$("#chatRequests").on("click","li.chatRequest",function(){console.log($(this).data("user-id")),i($(this).data("user-id"))}),$("#userLanguage").on("change",function(){var e=$(this).find("option:selected"),t=e.val();a(t)}),socket=io(),$("#changeNameForm").submit(function(){return socket.emit("changeName",$("#usernameInput").val()),!1}),socket.on("chatMessage",function(e){$("#conversationTranscript").append($('<li class="normal">').text(e))}),socket.on("transcribedText",function(e){$("#conversationSection h3").length>0&&$("#conversationSection h3").fadeOut("fast",function(){$("#conversationSection h3").remove()}),$("#conversationTranscript").append($('<li class="transcribed">').text(e))}),socket.on("startChat",function(n,i){console.log("starting chat"),$("#conversationSection").show(),t(n,i),e()}),socket.on("receiveChatRequest",function(e){console.log("recieved: "+e),0==$("#chatRequests").find('[data-user-id="'+e.id+'"]').length&&($("html, body").animate({scrollTop:$("h3.requestTop").offset().top},300),$("#chatRequests").append('<li class="chatRequest" data-user-id="'+e.id+'">'+e.name+"</li>"))}),socket.on("updatedUserObject",function(e){s=e,$("#usernameInput").val(e.name)}),socket.on("listOfUsersOnline",function(e){$("#onlineUsers").empty();for(var t=Object.keys(e),n=0;n<t.length;++n){var i=e[t[n]];console.log(i),i.hasOwnProperty("image")?i.id!=s.id&&$("#onlineUsers").append('<li class="onlineUser" data-user-id="'+i.id+'">'+i.name+'<img src="data:image/png;base64,'+i.image+'" /></li>'):i.id!=s.id&&$("#onlineUsers").append('<li class="onlineUser" data-user-id="'+i.id+'">'+i.name+"</li>")}}),socket.on("receivedSessionDescription",function(e){console.log("received session description: "+e)}),socket.on("receivedCandidateEvent",function(e){console.log("got candidate event");new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate})})}function loadChatRoom(e){console.log("loading");var t=e;console.log(t),$("body").fadeOut("fast",function(){$("body").load("/chat.html .chat-parent",function(){publisher=OT.initPublisher(apiKey,"videoSelfie"),session.publish(publisher,function(){if(0==imageCount){imageCount++;var e=publisher.getImgData();socket.emit("userImage",e)}}),$("body").fadeIn("fast"),console.log(t),loadDrawer(t),checkDom()})})}function sendString(e){$("#conversationSection h3").length>0&&$("#conversationSection h3").fadeOut("fast",function(){$("#conversationSection h3").remove()}),socket.emit("chatMessage",e)}function loadDrawer(e){$(".drawer .location .city").html(e.city),$(".drawer .location .country").html(e.country),$(".drawer .location .time").html(e.city),$(".drawer .weather .icon").html('<img src="'+e.icon+'" />'),$(".drawer .weather .temp").html(Math.round(e.temperature)+" &#176;C <br>"+e.weather);var t=new Date(e.local_time),n=t.getMinutes(),i=t.getHours();$(".drawer .time").html("Their local time is: <br>"+n+":"+i)}function enterShort(){$(".text-button").click(function(){sendString($(".text-submit textarea").val()),TweenMax.to(".text-submit textarea",.2,{opacity:0,onComplete:function(){$("textarea").val(""),TweenMax.to(".text-submit textarea",.1,{opacity:1})}})}),$(".text-submit textarea").bind("keydown",function(e){var t=e.keyCode||e.which;if(13==t&&0==e.shiftKey&&$(".text-submit textarea").val().length>0){var n=$(".text-submit textarea").val(),i=n.match(/\n/g),o=i?i.length:0;1!=$(".text-submit textarea").val().length||1!=o?(sendString($(".text-submit textarea").val()),TweenMax.to(".text-submit textarea",.2,{opacity:0,onComplete:function(){$("textarea").val(""),TweenMax.to(".text-submit textarea",.1,{opacity:1})}})):$("textarea").val("")}})}function autoResize(e){var t=e.target,n=t.scrollTop;t.scrollTop=0;var i,o=$(".text-area").height()-30;0!=e.shiftKey||13!=e.keyCode&&13!=e.which?(i=t.offsetHeight+n+n>o?o:t.offsetHeight+n+n,0==$("textarea").val().length&&(t.style.height="14px",$(".text-submit").css("height","30px")),n>0&&(t.style.height=i-16+"px",$(".text-submit").css("height",i+"px"))):(t.style.height="14px",$(".text-submit").css("height","30px"))}function runResizes(){$(".recipient").resizable({resize:function(){$(".text-area").css("height",$("body").height()-$(".recipient").height()+"px")},maxHeight:.85*$("body").height(),minHeight:.15*$("body").height(),handles:"s"}),$(".viewer").resizable({aspectRatio:!0,maxWidth:$(".recipient").width()/2,minWidth:50,handles:"e"})}function checkDom(){$(".chat").length>0&&(runResizes(),enterShort()),$("input:text").each(function(){var e=this.value;$(this).blur(function(){0==this.value.length&&(this.value=e)}).focus(function(){this.value=""})})}var publisher,session,apiKey,socket,imageCount=0,shared;$(document).ready(function(){checkDom(),runSocket()});